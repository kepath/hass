---
esphome:
  name: "${device_name}"
  friendly_name: "${friendly_name}"
  area: "${area}"
  on_boot:
    - priority: 300
      then:
        - light.turn_off: "${device_name}_lightid1"
        - logger.log: "startup - light should be off"

esp8266:
  board: "esp01_1m"

light:
  - platform: "binary"
    name: "${device_name}_light_1"
    output: "${device_name}_shellyrelay1"
    id: "${device_name}_lightid1"
    icon: "${light1_icon}"

output:
  - platform: "gpio"
    pin: "GPIO5"
    id: "${device_name}_shellyrelay1"

binary_sensor:
  - platform: "status"
    name: "${device_name}_status"
    icon: "mdi:web-check"
    device_class: "connectivity"
    filters:
      - delayed_off: "5min"
  - platform: "gpio"
    pin:
      number: "GPIO4"
    name: "${device_name}_switch_1"
    id: "${device_name}_switchid1"
    icon: "mdi:light-switch"
    on_state:
      then:
        - light.toggle: "${device_name}_lightid1"
    filters:
      - delayed_on_off: "50ms"
  - platform: "gpio"
    pin:
      number: "GPIO14"
    name: "${device_name}_switch_2"
    id: "${device_name}_switchid2"
    icon: "mdi:light-switch"
    disabled_by_default: true

mdns:
  services:
    - service: "_${device_name}"
      protocol: "_udp"
      port: 5353

wifi:
  ssid: "${ssid}"
  password: !secret "not_wifi_password"
  domain: ".not"
  reboot_timeout: "30min"
  on_connect:
    - light.turn_off: "${device_name}_lightid1"
  on_disconnect:
    - light.turn_off: "${device_name}_lightid1"
  manual_ip:
    static_ip: "192.168.30.${device_ip}"
    gateway: "192.168.30.1"
    subnet: "255.255.255.0"
    dns1: "192.168.30.1"
  min_auth_mode: "WPA2"
  power_save_mode: "none"

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "${device_name}"
    manual_ip:
      static_ip: "192.168.100.${device_ip}"
      gateway: "192.168.100.1"
      subnet: "255.255.255.0"
      dns1: "8.8.8.8"
      dns2: "8.8.4.4"
    ap_timeout: "10min"

captive_portal:

logger:
  level: "${log_level}"
api:
  reboot_timeout: "30min"
ota:
  platform: "esphome"
web_server:
  port: 80
  version: 3

# Text sensors with general information.
text_sensor:
  - platform: "version"
    name: "${device_name}_esphome_version"
  - platform: "wifi_info"
    ip_address:
      name: "${device_name}_IP"
      icon: "mdi:ip-network"
    ssid:
      name: "${device_name}_SSID"
      icon: "mdi:access-point-network"
    bssid:
      name: "${device_name}_BSSID"
      icon: "mdi:router-wireless-settings"
    mac_address:
      name: "${device_name}_MAC"
      icon: "mdi:router-network"

sensor:
  - platform: "ntc"
    sensor: "temp_resistance_reading"
    name: "${device_name}_temperature"
    unit_of_measurement: "Â°C"
    accuracy_decimals: 1
    icon: "mdi:thermometer"
    calibration:
      b_constant: 3350
      reference_resistance: "10kOhm"
      reference_temperature: "298.15K"
    on_value_range:
      - above: "${max_temp}"
        then:
          - light.turn_off: "${device_name}_lightid1"
          - homeassistant.service:
              service: "persistent_notification.create"
              data:
                title: "Message from ${device_name}"
              data_template:
                message: "Switch turned off because temperature exceeded ${max_temp}C"
  - platform: "resistance"
    id: "temp_resistance_reading"
    sensor: "temp_analog_reading"
    configuration: "DOWNSTREAM"
    resistor: "32kOhm"
  - platform: "adc"
    id: "temp_analog_reading"
    pin: "A0"
  - platform: "wifi_signal"
    name: "${device_name}_RSSI"
    id: "wifi_signal_db"
    update_interval: "60s"
    icon: "mdi:wifi"
    entity_category: "diagnostic"
  - platform: copy # Reports the WiFi signal strength in %
    source_id: "wifi_signal_db"
    name: "${device_name}_wifi_percent"
    filters:
      - lambda: "return min(max(2 * (x + 100.0), 0.0), 100.0);"
    unit_of_measurement: "%"
    entity_category: "diagnostic"
    device_class: ""

  - platform: "uptime"
    type: "seconds"
    name: "${device_name}_uptime"
status_led:
  pin: "GPIO0"
