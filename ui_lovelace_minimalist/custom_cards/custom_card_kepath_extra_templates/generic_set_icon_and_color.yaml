---
generic_set_icon_and_color:
  variables:
    ulm_card_kepath_generic_icon_appearance:
      evaluated_object: >
        [[[
          var entity = entity.entity_id;
          if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.evaluated_object) {
            entity = variables.ulm_card_kepath_extra_templates_icon_appearance.evaluated_object;
          }
          return entity;
        ]]]
      use_theme_colors: >
        [[[
          var useThemeColors = false;
          if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.use_theme_colors) {
            if (typeof variables.ulm_card_kepath_extra_templates_icon_appearance.use_theme_colors === "boolean") {
              useThemeColors = variables.ulm_card_kepath_extra_templates_icon_appearance.use_theme_colors;
            }
          }
          return useThemeColors;
        ]]]
      trigger_on_reversed: >
        [[[
          var triggerOnReversed = false;
          if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.trigger_on_reversed) {
            if (typeof variables.ulm_card_kepath_extra_templates_icon_appearance.trigger_on_reversed === "boolean") {
              triggerOnReversed = variables.ulm_card_kepath_extra_templates_icon_appearance.trigger_on_reversed;
            }
          }
          return triggerOnReversed;
        ]]]
      default:
        icon: >
          [[[
            var setIcon = "mdi:close-circle";
            if (entity?.attributes?.icon) {
              setIcon = entity.attributes.icon;
            }
            if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.default_theme) {
              if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.default_theme?.default_state) {
                if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.default_theme?.default_state?.icon) {
                  setIcon = variables.ulm_card_kepath_extra_templates_icon_appearance.default_theme.default_state.icon;
                }
              }
            }
            if (hass.themes.darkMode) {
              if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.dark_theme) {
                if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.dark_theme?.default_state) {
                  if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.dark_theme?.default_state?.icon) {
                    setIcon = variables.ulm_card_kepath_extra_templates_icon_appearance.dark_theme.default_state.icon;
                  }
                }
              }
            }
            return setIcon;
          ]]]
        icon_color: >
          [[[
            var setColor = "red";
            if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.default_theme) {
              if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.default_theme?.default_state) {
                if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.default_theme?.default_state?.icon_color) {
                  setColor = variables.ulm_card_kepath_extra_templates_icon_appearance.default_theme.default_state.icon_color;
                }
              }
            }
            if (hass.themes.darkMode) {
              if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.dark_theme) {
                if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.dark_theme?.default_state) {
                  if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.dark_theme?.default_state?.icon_color) {
                    setColor = variables.ulm_card_kepath_extra_templates_icon_appearance.dark_theme.default_state.icon_color;
                  }
                }
              }
            }
            return setColor;
          ]]]
        background_color: >
          [[[
            var setBGColor = "grey";
            if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.default_theme) {
              if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.default_theme?.default_state) {
                if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.default_theme?.default_state?.background_color) {
                  setBGColor = variables.ulm_card_kepath_extra_templates_icon_appearance.default_theme.default_state.background_color;
                }
              }
            }
            if (hass.themes.darkMode) {
              if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.dark_theme) {
                if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.dark_theme?.default_state) {
                  if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.dark_theme?.default_state?.background_color) {
                    setBGColor = variables.ulm_card_kepath_extra_templates_icon_appearance.dark_theme.default_state.background_color;
                  }
                }
              }
            }
            return setBGColor;
          ]]]
      triggered:
        icon: >
          [[[
            var setIcon = "mdi:close-circle";
            if (entity?.attributes?.icon) {
              setIcon = entity.attributes.icon;
            }
            if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.default_theme) {
              if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.default_theme?.triggered_state) {
                if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.default_theme?.triggered_state?.icon) {
                  setIcon = variables.ulm_card_kepath_extra_templates_icon_appearance.default_theme.triggered_state.icon;
                }
              }
            }
            if (hass.themes.darkMode) {
              if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.dark_theme) {
                if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.dark_theme?.triggered_state) {
                  if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.dark_theme?.triggered_state?.icon) {
                    setIcon = variables.ulm_card_kepath_extra_templates_icon_appearance.dark_theme.triggered_state.icon;
                  }
                }
              }
            }
            return setIcon;
          ]]]
        icon_color: >
          [[[
            var setColor = "red";
            if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.default_theme) {
              if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.default_theme?.triggered_state) {
                if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.default_theme?.triggered_state?.icon_color) {
                  setColor = variables.ulm_card_kepath_extra_templates_icon_appearance.default_theme.triggered_state.icon_color;
                }
              }
            }
            if (hass.themes.darkMode) {
              if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.dark_theme) {
                if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.dark_theme?.triggered_state) {
                  if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.dark_theme?.triggered_state?.icon_color) {
                    setColor = variables.ulm_card_kepath_extra_templates_icon_appearance.dark_theme.triggered_state.icon_color;
                  }
                }
              }
            }
            return setColor;
          ]]]
        background_color: >
          [[[
            var setBGColor = "grey";
            if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.default_theme) {
              if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.default_theme?.triggered_state) {
                if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.default_theme?.triggered_state?.background_color) {
                  setBGColor = variables.ulm_card_kepath_extra_templates_icon_appearance.default_theme.triggered_state.background_color;
                }
              }
            }
            if (hass.themes.darkMode) {
              if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.dark_theme) {
                if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.dark_theme?.triggered_state) {
                  if (variables?.ulm_card_kepath_extra_templates_icon_appearance?.dark_theme?.triggered_state?.background_color) {
                    setBGColor = variables.ulm_card_kepath_extra_templates_icon_appearance.dark_theme.triggered_state.background_color;
                  }
                }
              }
            }
            return setBGColor;
          ]]]

  state:
    - operator: "template"
      value: >
        [[[
          //hass.callService('system_log', 'write', {level:'info',message:'variables.ulm_card_kepath_generic_icon_appearance.evaluated_object ' + variables.ulm_card_kepath_generic_icon_appearance.evaluated_object});
          var stateValue = false;
          var evaluatedState = null;
          if (states[variables.ulm_card_kepath_generic_icon_appearance.evaluated_object]?.state) {
            evaluatedState = states[variables.ulm_card_kepath_generic_icon_appearance.evaluated_object].state
          }
          if (!variables.ulm_card_kepath_generic_icon_appearance.trigger_on_reversed) {
            if (isNaN(evaluatedState)) {
              if (evaluatedState == 'on'
                  || evaluatedState == 'recording'
                  || evaluatedState == 'idle'
                  || evaluatedState == 'away') {
                stateValue = true;
              }
            }
            else {
              if (evaluatedState != 0) {
                stateValue = true;
              }
            }
          }
          else {
            if (isNaN(evaluatedState)) {
              if (evaluatedState == 'off'
                  || evaluatedState == 'playing'
                  || evaluatedState == 'home') {
                stateValue = true;
              }
            }
            else {
              if (evaluatedState == 0) {
                stateValue = true;
              }
            }
          }

          return stateValue;
        ]]]
      icon: >
        [[[
          var icon = "mdi:close-circle";
          if (variables.ulm_card_kepath_generic_icon_appearance.triggered.icon != icon) {
            icon = variables.ulm_card_kepath_generic_icon_appearance.triggered.icon;
          } else {
            icon = variables.ulm_card_kepath_generic_icon_appearance.default.icon;
          }
          return icon;
        ]]]
      styles:
        icon:
          - color: >
              [[[
                var returnedColor = "red";
                var testColor = "red";
                const colorOptions = ['color-grey', 'color-red', 'color-green', 'color-yellow', 'color-blue', 'color-purple', 'color-pink', 'color-amber', 'color-theme'];
                if (variables.ulm_card_kepath_generic_icon_appearance.triggered.icon_color != returnedColor) {
                  testColor = variables.ulm_card_kepath_generic_icon_appearance.triggered.icon_color;
                } else {
                  testColor = variables.ulm_card_kepath_generic_icon_appearance.default.icon_color;
                }
                if (variables.ulm_card_kepath_generic_icon_appearance.use_theme_colors) {
                  for (let i = 0; i < colorOptions.length; i++) {
                    if (testColor.includes(colorOptions[i])){
                      returnedColor = testColor;
                    }
                  }
                } else {
                  returnedColor = testColor;
                }
                return returnedColor;
              ]]]
        img_cell:
          - background-color: >
              [[[
                var returnedBGColor = "grey";
                var testBGColor = "grey";
                const colorOptions = ['color-grey', 'color-red', 'color-green', 'color-yellow', 'color-blue', 'color-purple', 'color-pink', 'color-amber', 'color-theme'];
                if (variables.ulm_card_kepath_generic_icon_appearance.triggered.background_color != returnedBGColor) {
                  testBGColor = variables.ulm_card_kepath_generic_icon_appearance.triggered.background_color;
                } else {
                  testBGColor = variables.ulm_card_kepath_generic_icon_appearance.default.background_color;
                }
                if (variables.ulm_card_kepath_generic_icon_appearance.use_theme_colors) {
                  for (let i = 0; i < colorOptions.length; i++) {
                    if (testBGColor.includes(colorOptions[i])){
                      returnedBGColor = testBGColor;
                    }
                  }
                } else {
                  returnedBGColor = testBGColor;
                }
                return returnedBGColor;
              ]]]
    - operator: "default"
      icon: "[[[ return variables.ulm_card_kepath_generic_icon_appearance.default.icon; ]]]"
      styles:
        icon:
          - color: "[[[ return variables.ulm_card_kepath_generic_icon_appearance.default.icon_color; ]]]"
        img_cell:
          - background-color: "[[[ return variables.ulm_card_kepath_generic_icon_appearance.default.background_color; ]]]"

# hass.callService('system_log', 'write', {level:'info',message:'mode.dark.default.icon '+setIcon});
