---
device_kepath_entity_and_style_washing_machine_extra_states:
  variables:
    var_kepath_device_entity_and_style_washing_machine:
      data_entities:
        start_entity: "input_datetime.washing_machine_instantaneous_demand_above_10w"
      use_themes: true
      active_state:
        icon: "mdi:washing-machine"
        icon_color: "green"
        background_color: "green"
      standby_state:
        icon: "mdi:power-standby"
        icon_color: "green"
        background_color: "green"
      off_state:
        icon: "mdi:washing-machine-off"
        icon_color: "blue"
        background_color: "blue"

  state:
    - value: "active"
      icon: >
        [[[
          var backupIcon =  "mdi:circle-outline";
          var returnedIcon;
          if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.active_state?.icon !== 'undefined') {
            if (variables?.var_kepath_device_entity_and_style_washing_machine?.active_state?.icon.includes('mdi:') ||
                variables?.var_kepath_device_entity_and_style_washing_machine?.active_state?.icon.includes('phu:') ||
                variables?.var_kepath_device_entity_and_style_washing_machine?.active_state?.icon.includes('si:')) {
              returnedIcon = variables?.var_kepath_device_entity_and_style_washing_machine?.active_state?.icon;
            }
          }
          if (typeof returnedIcon !== 'undefined') {
            //hass.callService('system_log', 'write', {level:'warning',message:'returnedIcon: ' + returnedIcon});
            return returnedIcon;
          } else {
            return backupIcon;
          }
        ]]]
      # [[[
      #   var backupIcon =  "mdi:circle-outline";
      #   var returnedIcon;
      #   if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.active_state?.icon !== 'undefined') {
      #     if (variables?.var_kepath_device_entity_and_style_washing_machine?.active_state?.icon.includes('mdi:') ||
      #         variables?.var_kepath_device_entity_and_style_washing_machine?.active_state?.icon.includes('phu:') ||
      #         variables?.var_kepath_device_entity_and_style_washing_machine?.active_state?.icon.includes('si:')) {
      #       returnedIcon = variables?.var_kepath_device_entity_and_style_washing_machine?.active_state?.icon;
      #     }
      #   }

      #   var evaluatedStartEntity = variables?.var_kepath_device_entity_and_style_washing_machine?.data_entities?.start_entity;
      #   var resolvedStartState = states[evaluatedStartEntity].state;
      #   var estimatedLengthHours = 2;

      #   //hass.callService('system_log', 'write', {level:'warning',message:'resolvedStartState: ' + resolvedStartState});


      #   if (typeof resolvedStartState !== 'undefined') {
      #     var resolvedStartDate = new Date(resolvedStartState);
      #     if (Object.prototype.toString.call(resolvedStartDate) === "[object Date]") {
      #       if (!isNaN(resolvedStartDate)) {
      #         var estimatedLengthMilliseconds = (estimatedLengthHours * 60 * 60 * 1000);
      #         //hass.callService('system_log', 'write', {level:'warning',message:'estimatedLengthMilliseconds: ' + estimatedLengthMilliseconds});
      #         var estimatedEndDate = Date.parse(resolvedStartDate) + estimatedLengthMilliseconds;
      #         //hass.callService('system_log', 'write', {level:'warning',message:'estimatedEndDate: ' + estimatedEndDate});
      #         if(!isNaN(parseInt(estimatedEndDate))) {
      #           var estimatedLengthMilliseconds = estimatedEndDate - Date.now()
      #           var estimatedLengthHours = (estimatedLengthMilliseconds / (1000 * 60 * 60)).toFixed();
      #           //hass.callService('system_log', 'write', {level:'warning',message:'estimatedLengthHours: ' + estimatedLengthHours});
      #           if(!isNaN(parseInt(estimatedLengthHours))) {
      #             if (!estimatedLengthHours.includes("-")) {
      #               if (estimatedLengthHours >= 0 && estimatedLengthHours <= 9) {
      #                 returnedIcon = "mdi:numeric-" + estimatedLengthHours + "-circle-outline";
      #               }
      #             }
      #           }
      #         }
      #       }
      #     }
      #   }
      #   //hass.callService('system_log', 'write', {level:'warning',message:'returnedIcon: ' + returnedIcon});

      #   if (typeof returnedIcon !== 'undefined') {
      #     //hass.callService('system_log', 'write', {level:'warning',message:'returnedIcon: ' + returnedIcon});
      #     return returnedIcon;
      #   } else {
      #     return backupIcon;
      #   }
      # ]]]
      styles:
        icon:
          - color: >
              [[[
                var returnedColorDefault = "yellow";
                var returnedColor;
                var useThemesDefault = true;
                var useThemes;
                const colorOptions = ['grey', 'red', 'green', 'yellow', 'blue', 'purple', 'pink', 'amber', 'theme'];
                if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.use_themes !== 'undefined') {
                  if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.use_themes === 'boolean') {
                    useThemes = variables?.var_kepath_device_entity_and_style_washing_machine?.use_themes;
                  } else {
                    useThemes = useThemesDefault;
                  }
                } else {
                  useThemes = useThemesDefault;
                }
                //returnedColor = if_variable_undefined_use_default(variables?.var_kepath_device_entity_and_style_washing_machine?.active_state?.icon_color,returnedColorDefault)
                if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.active_state?.icon_color !== 'undefined') {
                  returnedColor = variables?.var_kepath_device_entity_and_style_washing_machine?.active_state?.icon_color;
                } else {
                  returnedColor = returnedColorDefault;
                }
                if (useThemes) {
                  for (let i = 0; i < colorOptions.length; i++) {
                    if (returnedColor.includes(colorOptions[i])){
                      returnedColor = "rgba(var(--color-" + returnedColor + "), 1)";
                    }
                  }
                }
                //hass.callService('system_log', 'write', {level:'warning',message:'returnedColor: ' + returnedColor});

                return returnedColor;
              ]]]
        img_cell:
          - background-color: >
              [[[
                var returnedColorDefault = "yellow";
                var returnedColor;
                var useThemesDefault = true;
                var useThemes;
                const colorOptions = ['grey', 'red', 'green', 'yellow', 'blue', 'purple', 'pink', 'amber', 'theme'];
                if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.use_themes !== 'undefined') {
                  if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.use_themes === 'boolean') {
                    useThemes = variables?.var_kepath_device_entity_and_style_washing_machine?.use_themes;
                  } else {
                    useThemes = useThemesDefault;
                  }
                } else {
                  useThemes = useThemesDefault;
                }
                if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.active_state?.background_color !== 'undefined') {
                  returnedColor = variables?.var_kepath_device_entity_and_style_washing_machine?.active_state?.background_color;
                } else {
                  returnedColor = returnedColorDefault;
                }
                if (useThemes) {
                  for (let i = 0; i < colorOptions.length; i++) {
                    if (returnedColor.includes(colorOptions[i])){
                      returnedColor = "rgba(var(--color-" + returnedColor + "), 0.2)";
                    }
                  }
                }
                //hass.callService('system_log', 'write', {level:'warning',message:'returnedColor: ' + returnedColor});

                return returnedColor;
              ]]]
    - value: "standby"
      icon: >
        [[[
          var backupIcon =  "mdi:circle-outline";
          var returnedIcon;
          if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.standby_state?.icon !== 'undefined') {
            if (variables?.var_kepath_device_entity_and_style_washing_machine?.standby_state?.icon.includes('mdi:') ||
                variables?.var_kepath_device_entity_and_style_washing_machine?.standby_state?.icon.includes('phu:') ||
                variables?.var_kepath_device_entity_and_style_washing_machine?.standby_state?.icon.includes('si:')) {
              returnedIcon = variables?.var_kepath_device_entity_and_style_washing_machine?.standby_state?.icon;
            }
          }
          if (typeof returnedIcon !== 'undefined') {
            //hass.callService('system_log', 'write', {level:'warning',message:'returnedIcon: ' + returnedIcon});
            return returnedIcon;
          } else {
            return backupIcon;
          }
        ]]]
      styles:
        icon:
          - color: >
              [[[
                var returnedColorDefault = "yellow";
                var returnedColor;
                var useThemesDefault = true;
                var useThemes;
                const colorOptions = ['grey', 'red', 'green', 'yellow', 'blue', 'purple', 'pink', 'amber', 'theme'];
                if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.use_themes !== 'undefined') {
                  if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.use_themes === 'boolean') {
                    useThemes = variables?.var_kepath_device_entity_and_style_washing_machine?.use_themes;
                  } else {
                    useThemes = useThemesDefault;
                  }
                } else {
                  useThemes = useThemesDefault;
                }
                //returnedColor = if_variable_undefined_use_default(variables?.var_kepath_device_entity_and_style_washing_machine?.standby_state?.icon_color,returnedColorDefault)
                if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.standby_state?.icon_color !== 'undefined') {
                  returnedColor = variables?.var_kepath_device_entity_and_style_washing_machine?.standby_state?.icon_color;
                } else {
                  returnedColor = returnedColorDefault;
                }
                if (useThemes) {
                  for (let i = 0; i < colorOptions.length; i++) {
                    if (returnedColor.includes(colorOptions[i])){
                      returnedColor = "rgba(var(--color-" + returnedColor + "), 1)";
                    }
                  }
                }
                //hass.callService('system_log', 'write', {level:'warning',message:'returnedColor: ' + returnedColor});

                return returnedColor;
              ]]]
        img_cell:
          - background-color: >
              [[[
                var returnedColorDefault = "yellow";
                var returnedColor;
                var useThemesDefault = true;
                var useThemes;
                const colorOptions = ['grey', 'red', 'green', 'yellow', 'blue', 'purple', 'pink', 'amber', 'theme'];
                if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.use_themes !== 'undefined') {
                  if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.use_themes === 'boolean') {
                    useThemes = variables?.var_kepath_device_entity_and_style_washing_machine?.use_themes;
                  } else {
                    useThemes = useThemesDefault;
                  }
                } else {
                  useThemes = useThemesDefault;
                }
                if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.standby_state?.background_color !== 'undefined') {
                  returnedColor = variables?.var_kepath_device_entity_and_style_washing_machine?.standby_state?.background_color;
                } else {
                  returnedColor = returnedColorDefault;
                }
                if (useThemes) {
                  for (let i = 0; i < colorOptions.length; i++) {
                    if (returnedColor.includes(colorOptions[i])){
                      returnedColor = "rgba(var(--color-" + returnedColor + "), 0.2)";
                    }
                  }
                }
                //hass.callService('system_log', 'write', {level:'warning',message:'returnedColor: ' + returnedColor});

                return returnedColor;
              ]]]
    - value: "off"
      icon: >
        [[[
          var backupIcon =  "mdi:circle-outline";
          var returnedIcon;
          if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.off_state?.icon !== 'undefined') {
            if (variables?.var_kepath_device_entity_and_style_washing_machine?.off_state?.icon.includes('mdi:') ||
                variables?.var_kepath_device_entity_and_style_washing_machine?.off_state?.icon.includes('phu:') ||
                variables?.var_kepath_device_entity_and_style_washing_machine?.off_state?.icon.includes('si:')) {
              returnedIcon = variables?.var_kepath_device_entity_and_style_washing_machine?.off_state?.icon;
            }
          }
          if (typeof returnedIcon !== 'undefined') {
            //hass.callService('system_log', 'write', {level:'warning',message:'returnedIcon: ' + returnedIcon});
            return returnedIcon;
          } else {
            return backupIcon;
          }
        ]]]
      styles:
        icon:
          - color: >
              [[[
                var returnedColorDefault = "yellow";
                var returnedColor;
                var useThemesDefault = true;
                var useThemes;
                const colorOptions = ['grey', 'red', 'green', 'yellow', 'blue', 'purple', 'pink', 'amber', 'theme'];
                if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.use_themes !== 'undefined') {
                  if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.use_themes === 'boolean') {
                    useThemes = variables?.var_kepath_device_entity_and_style_washing_machine?.use_themes;
                  } else {
                    useThemes = useThemesDefault;
                  }
                } else {
                  useThemes = useThemesDefault;
                }
                //returnedColor = if_variable_undefined_use_default(variables?.var_kepath_device_entity_and_style_washing_machine?.off_state?.icon_color,returnedColorDefault)
                if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.off_state?.icon_color !== 'undefined') {
                  returnedColor = variables?.var_kepath_device_entity_and_style_washing_machine?.off_state?.icon_color;
                } else {
                  returnedColor = returnedColorDefault;
                }
                if (useThemes) {
                  for (let i = 0; i < colorOptions.length; i++) {
                    if (returnedColor.includes(colorOptions[i])){
                      returnedColor = "rgba(var(--color-" + returnedColor + "), 1)";
                    }
                  }
                }
                //hass.callService('system_log', 'write', {level:'warning',message:'returnedColor: ' + returnedColor});

                return returnedColor;
              ]]]
        img_cell:
          - background-color: >
              [[[
                var returnedColorDefault = "yellow";
                var returnedColor;
                var useThemesDefault = true;
                var useThemes;
                const colorOptions = ['grey', 'red', 'green', 'yellow', 'blue', 'purple', 'pink', 'amber', 'theme'];
                if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.use_themes !== 'undefined') {
                  if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.use_themes === 'boolean') {
                    useThemes = variables?.var_kepath_device_entity_and_style_washing_machine?.use_themes;
                  } else {
                    useThemes = useThemesDefault;
                  }
                } else {
                  useThemes = useThemesDefault;
                }
                if (typeof variables?.var_kepath_device_entity_and_style_washing_machine?.off_state?.background_color !== 'undefined') {
                  returnedColor = variables?.var_kepath_device_entity_and_style_washing_machine?.off_state?.background_color;
                } else {
                  returnedColor = returnedColorDefault;
                }
                if (useThemes) {
                  for (let i = 0; i < colorOptions.length; i++) {
                    if (returnedColor.includes(colorOptions[i])){
                      returnedColor = "rgba(var(--color-" + returnedColor + "), 0.2)";
                    }
                  }
                }
                //hass.callService('system_log', 'write', {level:'warning',message:'returnedColor: ' + returnedColor});

                return returnedColor;
              ]]]
