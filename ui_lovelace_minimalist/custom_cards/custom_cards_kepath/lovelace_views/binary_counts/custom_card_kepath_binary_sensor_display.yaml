---
custom_card_kepath_binary_sensor_display:
  variables:
    ulm_card_kepath_position_overrides:
      evaluated_position_entity: >
        [[[
          var entity = entity?.entity_id;
          if (variables?.ulm_card_kepath_position_overrides?.evaluated_position_entity) {
            entity = variables.ulm_card_kepath_position_overrides.evaluated_position_entity;
          }
          return entity;
        ]]]
      is_compact_mode: >
        [[[
          var isCompactMode = false;
          if (variables?.ulm_card_kepath_position_overrides) {
            if (variables?.ulm_card_kepath_position_overrides?.is_compact_mode) {
              if (typeof variables.ulm_card_kepath_position_overrides.is_compact_mode === "boolean") {
                isCompactMode = variables.ulm_card_kepath_position_overrides.is_compact_mode;
              }
            }
          }
          return isCompactMode;
        ]]]
      off_state_only: >
        [[[
          var offStateOnly = false;
          if (variables?.ulm_card_kepath_position_overrides) {
            if (variables?.ulm_card_kepath_position_overrides?.off_state_only) {
              if (typeof variables?.ulm_card_kepath_position_overrides?.off_state_only === "boolean") {
                offStateOnly = variables?.ulm_card_kepath_position_overrides?.off_state_only;
              }
            }
          }
          return offStateOnly;
        ]]]
      position_type: >
        [[[
          var returnedPositionType = "popup";
          const positionTypes = ["popup", "floorplan", "tab"];
          if (variables?.ulm_card_kepath_position_overrides) {
            if (variables?.ulm_card_kepath_position_overrides?.position_type) {
              for (let i = 0; i < positionTypes.length; i++) {
                if (variables?.ulm_card_kepath_position_overrides?.position_type.includes(positionTypes[i])) {
                  returnedPositionType = variables?.ulm_card_kepath_position_overrides?.position_type;
                }
              }
            }
          }
          return returnedPositionType;
        ]]]
      popup:
        unavailable:
          left: "60%"
          top: "0px"
          width: "20px"
          height: "20px"
        amount:
          left: "60%"
          top: "32px"
          width: "20px"
          height: "20px"
      floorplan:
        unavailable:
          left: "81%"
          top: "5px"
          width: "14px"
          height: "14px"
        amount:
          left: "15px"
          top: "5px"
          width: "14px"
          height: "14px"
      tab:
        unavailable:
          left: "60%"
          top: "6px"
          width: "20px"
          height: "20px"
        amount:
          left: "60%"
          top: "38px"
          width: "20px"
          height: "20px"
      tab-alternative:
        unavailable:
          left: "64%"
          top: "9px"
          width: "14px"
          height: "14px"
        amount:
          left: "64%"
          top: "41px"
          width: "14px"
          height: "14px"

    ulm_card_kepath_binary_sensor_count_notifications:
      unavailable:
        entity: "sensor.binary_sensor_state_counts"
        is_attribute: >
          [[[
            var isValueAttribute = true;
            if (variables?.ulm_card_kepath_binary_sensor_count_notifications?.unavailable?.is_attribute) {
              if (typeof variables.ulm_card_kepath_binary_sensor_count_notifications.unavailable.is_attribute === "boolean") {
                isValueAttribute = variables.ulm_card_kepath_binary_sensor_count_notifications.unavailable.is_attribute;
              }
            }
            return isValueAttribute;
          ]]]
        attribute_name: "zero_value"
        count_tooltip: ""
      amount:
        entity: "sensor.binary_sensor_state_counts"
        is_attribute: >
          [[[
            var isValueAttribute = true;
            if (variables?.ulm_card_kepath_binary_sensor_count_notifications?.amount?.is_attribute) {
              if (typeof variables.ulm_card_kepath_binary_sensor_count_notifications.amount.is_attribute === "boolean") {
                isValueAttribute = variables.ulm_card_kepath_binary_sensor_count_notifications.amount.is_attribute;
              }
            }
            return isValueAttribute;
          ]]]
        attribute_name: "zero_value"
        count_tooltip: ""
  template:
    - "icon_info_bg"
    - "ulm_translation_engine"
  icon: "mdi:lightbulb"
  show_icon: true
  show_label: false
  show_name: true
  group_expand: true
  triggers_update: "all"
  styles:
    grid:
      - grid-template-areas: "'i' 'n'"
      - grid-template-rows: "1fr min-content"
      - grid-template-columns: "1fr"
      - justify-items: "center"
    icon:
      - width: "20px"
    card:
      - box-shadow: "none"
      - border-radius: "none"
      - padding: "5px"
      - background-color: "rgba(var(--color-theme),0)"
    name:
      - place-self: "center"
      - font-weight: "bold"
      - font-size: "10px"
      - text-overflow: "ellipsis"
      - overflow: "hidden"
      - padding-top: "10px"
      - margin: "0"
      - min-width: "20px"
      - color: "var(--primary-text-color)"
    custom_fields:
      unavailable:
        - position: "absolute"
        - left: >
            [[[
              var positionType = "popup";
              if (variables?.ulm_card_kepath_position_overrides?.position_type) {
                positionType = variables?.ulm_card_kepath_position_overrides?.position_type;
                if (positionType == "tab") {
                  if (variables?.ulm_card_kepath_position_overrides?.off_state_only) {
                    if (states[variables?.ulm_card_kepath_position_overrides?.evaluated_position_entity]?.state == "off") {
                      if (!hass.themes.darkMode) {
                        positionType = "tab-alternative"
                      }
                    }
                  }
                }
              }
              return variables?.ulm_card_kepath_position_overrides?.[positionType]?.unavailable?.left
            ]]]
        - top: >
            [[[
              var positionType = "popup";
              if (variables?.ulm_card_kepath_position_overrides?.position_type) {
                positionType = variables?.ulm_card_kepath_position_overrides?.position_type;
                if (positionType == "tab") {
                  if (variables?.ulm_card_kepath_position_overrides?.off_state_only) {
                    if (states[variables?.ulm_card_kepath_position_overrides?.evaluated_position_entity]?.state == "off") {
                      if (!hass.themes.darkMode) {
                        positionType = "tab-alternative"
                      }
                    }
                  }
                }
              }
              return variables?.ulm_card_kepath_position_overrides?.[positionType]?.unavailable?.top
            ]]]
        - width: >
            [[[
              var positionType = "popup";
              if (variables?.ulm_card_kepath_position_overrides?.position_type) {
                positionType = variables?.ulm_card_kepath_position_overrides?.position_type;
                if (positionType == "tab") {
                  if (variables?.ulm_card_kepath_position_overrides?.off_state_only) {
                    if (states[variables?.ulm_card_kepath_position_overrides?.evaluated_position_entity]?.state == "off") {
                      if (!hass.themes.darkMode) {
                        positionType = "tab-alternative"
                      }
                    }
                  }
                }
              }
              return variables?.ulm_card_kepath_position_overrides?.[positionType]?.unavailable?.width
            ]]]
        - height: >
            [[[
              var positionType = "popup";
              if (variables?.ulm_card_kepath_position_overrides?.position_type) {
                positionType = variables?.ulm_card_kepath_position_overrides?.position_type;
                if (positionType == "tab") {
                  if (variables?.ulm_card_kepath_position_overrides?.off_state_only) {
                    if (states[variables?.ulm_card_kepath_position_overrides?.evaluated_position_entity]?.state == "off") {
                      if (!hass.themes.darkMode) {
                        positionType = "tab-alternative"
                      }
                    }
                  }
                }
              }
              return variables?.ulm_card_kepath_position_overrides?.[positionType]?.unavailable?.height
            ]]]
      amount:
        - position: "absolute"
        - left: >
            [[[
              var positionType = "popup";
              if (variables?.ulm_card_kepath_position_overrides?.position_type) {
                positionType = variables?.ulm_card_kepath_position_overrides?.position_type;
                if (positionType == "tab") {
                  if (variables?.ulm_card_kepath_position_overrides?.off_state_only) {
                    if (states[variables?.ulm_card_kepath_position_overrides?.evaluated_position_entity]?.state == "off") {
                      if (!hass.themes.darkMode) {
                        positionType = "tab-alternative"
                      }
                    }
                  }
                }
              }
              return variables?.ulm_card_kepath_position_overrides?.[positionType]?.amount?.left
            ]]]
        - top: >
            [[[
              var positionType = "popup";
              if (variables?.ulm_card_kepath_position_overrides?.position_type) {
                positionType = variables?.ulm_card_kepath_position_overrides?.position_type;
                if (positionType == "tab") {
                  if (variables?.ulm_card_kepath_position_overrides?.off_state_only) {
                    if (states[variables?.ulm_card_kepath_position_overrides?.evaluated_position_entity]?.state == "off") {
                      if (!hass.themes.darkMode) {
                        positionType = "tab-alternative"
                      }
                    }
                  }
                }
              }
              return variables?.ulm_card_kepath_position_overrides?.[positionType]?.amount?.top
            ]]]
        - width: >
            [[[
              var positionType = "popup";
              if (variables?.ulm_card_kepath_position_overrides?.position_type) {
                positionType = variables?.ulm_card_kepath_position_overrides?.position_type;
                if (positionType == "tab") {
                  if (variables?.ulm_card_kepath_position_overrides?.off_state_only) {
                    if (states[variables?.ulm_card_kepath_position_overrides?.evaluated_position_entity]?.state == "off") {
                      if (!hass.themes.darkMode) {
                        positionType = "tab-alternative"
                      }
                    }
                  }
                }
              }
              return variables?.ulm_card_kepath_position_overrides?.[positionType]?.amount?.width
            ]]]
        - height: >
            [[[
              var positionType = "popup";
              if (variables?.ulm_card_kepath_position_overrides?.position_type) {
                positionType = variables?.ulm_card_kepath_position_overrides?.position_type;
                if (positionType == "tab") {
                  if (variables?.ulm_card_kepath_position_overrides?.off_state_only) {
                    if (states[variables?.ulm_card_kepath_position_overrides?.evaluated_position_entity]?.state == "off") {
                      if (!hass.themes.darkMode) {
                        positionType = "tab-alternative"
                      }
                    }
                  }
                }
              }
              return variables?.ulm_card_kepath_position_overrides?.[positionType]?.amount?.height
            ]]]
      notification:
        - visibility: "hidden"

  custom_fields:
    unavailable:
      card:
        type: "custom:button-card"
        template: >
          [[[
            let styleTemplate = [ "widget_count_mdi_number_indicator" ];
            var extraTemplate = "widget_count_mdi_number_indicator_default_style"
            if (variables?.ulm_card_kepath_position_overrides?.is_compact_mode) {
              if (variables?.ulm_card_kepath_position_overrides?.off_state_only) {
                if (states[variables?.ulm_card_kepath_position_overrides?.evaluated_position_entity]?.state == "off") {
                  extraTemplate = "widget_count_mdi_number_indicator_compact_style"
                }
              } else {
                extraTemplate = "widget_count_mdi_number_indicator_compact_style"
              }
            }
            styleTemplate.push(extraTemplate);

            return styleTemplate;
          ]]]
        variables:
          notification_counts: "[[[ return variables?.ulm_card_kepath_binary_sensor_count_notifications?.unavailable; ]]]"
        entity: "[[[ return variables?.ulm_card_kepath_binary_sensor_count_notifications?.unavailable?.entity; ]]]"
    amount:
      card:
        type: "custom:button-card"
        template: >
          [[[
            let styleTemplate = [ "widget_count_mdi_number_indicator" ];
            var extraTemplate = "widget_count_mdi_number_indicator_default_style"
            if (variables?.ulm_card_kepath_position_overrides?.is_compact_mode) {
              if (variables?.ulm_card_kepath_position_overrides?.off_state_only) {
                if (states[variables?.ulm_card_kepath_position_overrides?.evaluated_position_entity]?.state == "off") {
                  extraTemplate = "widget_count_mdi_number_indicator_compact_style"
                }
              } else {
                extraTemplate = "widget_count_mdi_number_indicator_compact_style"
              }
            }
            styleTemplate.push(extraTemplate);

            return styleTemplate;
          ]]]
        variables:
          notification_counts: "[[[ return variables?.ulm_card_kepath_binary_sensor_count_notifications?.amount; ]]]"
        entity: "[[[ return variables?.ulm_card_kepath_binary_sensor_count_notifications?.amount?.entity; ]]]"


widget_count_mdi_number_indicator:
  show_icon: true
  show_label: false
  show_name: false
  group_expand: true
  style:
    $: >
      .tooltip .tooltiptext {
        display:none;
      }
  icon: >
    [[[
      var amountValue = 0;
      var icon = "mdi:numeric-0-circle";
      if (variables?.notification_counts?.is_attribute) {
        amountValue = states[variables?.notification_counts?.entity]?.attributes[variables?.notification_counts?.attribute_name] ? states[variables.notification_counts.entity].attributes[variables.notification_counts.attribute_name] : 0;
      } else {
        amountValue = states[variables?.notification_counts?.entity]?.state ? states[variables.notification_counts.entity].state : 0;
      }
      if (!isNaN(amountValue) && amountValue !== undefined){
        if (amountValue > 9) {
          amountValue = "9-plus";
        }
        icon = icon.replace("0",amountValue);
      }
      if (amountValue == "on") {
        icon = "mdi:arrow-up-bold-circle";
      }
      if(hass.themes.darkMode) {
        icon = icon.replace("-circle","");
      }
      return icon;
    ]]]
  state:
    - operator: "template"
      value: >
        [[[
          var isZeroValue = true;
          var amountValue = 0;
          if (variables?.notification_counts?.is_attribute) {
            amountValue = states[variables?.notification_counts?.entity]?.attributes[variables?.notification_counts?.attribute_name] ? states[variables.notification_counts.entity].attributes[variables.notification_counts.attribute_name] : 0;
          } else {
            amountValue = states[variables?.notification_counts?.entity]?.state ? states[variables.notification_counts.entity].state : 0;
          }
          if (!isNaN(amountValue) && amountValue != 0 && amountValue !== undefined) {
            isZeroValue = false;
          }
          if (amountValue == "on") {
            isZeroValue = false;
          }
          return isZeroValue;
        ]]]
      styles:
        card:
          - display: "none"
  tooltip: >
    [[[
      var tooltipValue = null;
      if(variables?.notification_counts?.count_tooltip) {
        tooltipValue = variables.notification_counts.count_tooltip;
      }
      return tooltipValue;
    ]]]


widget_count_mdi_number_indicator_default_style:
  styles:
    icon:
      - width: "14px"
      - height: "14px"
      - line-height: "0"
      - color: >
          [[[
            var iconColor = "rgba(var(--color-red),1)";
            if(hass.themes.darkMode) {
              iconColor = "rgba(var(--color-yellow),1)";
            }
            return iconColor;
          ]]]
    img_cell:
      - border-radius: "50%"
      - background-color: "rgba(var(--color-theme),0)"
      - height: "16px"
      - width: "16px"
      - border: "2px solid rgba(var(--color-theme),0)"
    card:
      - height: "20px"
      - width: "20px"
      - box-shadow: "none"
      - padding: "0"
      - border-radius: "50%"


widget_count_mdi_number_indicator_compact_style:
  styles:
    icon:
      - width: "14px"
      - height: "14px"
      - line-height: "0"
      - color: >
          [[[
            var iconColor = "rgba(var(--color-red),1)";
            if(hass.themes.darkMode) {
              iconColor = "rgba(var(--color-yellow),1)";
            }
            return iconColor;
          ]]]
    img_cell:
      - border-radius: "50%"
      - background-color: "rgba(var(--color-theme),0)"
      - height: "14px"
      - width: "14px"
      - border: "0px"
    card:
      - height: "14px"
      - width: "14px"
      - box-shadow: "none"
      - padding: "0"
      - border-radius: "50%"
