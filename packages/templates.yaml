---
template:
  - sensor:
      - name: "binary_sensor_status_counts"
        state: "{{ 'off' if states('sensor.hacs') | float == 0 else 'on' }}"
        attributes:
          updates_count: "{{ expand('group.all_updates') | selectattr('state','eq', 'on') | list | count }}"
          doors_open_count: "{{ expand('group.all_door_binary_sensors') | selectattr('state','eq', 'on') | list | count }}"
          door_sensors_unavailable_count: "{{ expand('group.all_door_binary_sensors') | selectattr('state','in', ['unavailable','unknown']) | list | count }}"
          lights_on_count: "{{ expand('group.all_lights') | selectattr('state','eq', 'on') | list | count }}"
          occupancy_count: "{{ expand('group.all_occupancy_binary_sensors') | selectattr('state','eq', 'on') | list | count }}"
          occupancy_sensors_unavailable_count: "{{ expand('group.all_occupancy_binary_sensors') | selectattr('state','in', ['unavailable','unknown']) | list | count }}"
          occupancy_persons_home_count: "{{ expand(states.person) | selectattr('state','eq','home') | map(attribute='entity_id') | list | count }}"
          safety_alert_count: "{{ expand('group.all_safety_binary_sensors') | selectattr('state','eq', 'on') | list | count }}"
          safety_sensors_unavailable_count: "{{ expand('group.all_safety_binary_sensors') | selectattr('state','in', ['unavailable','unknown']) | list | count }}"
          zero_value: "{{ 0 | int }}"

      # Shelly Light Diagnotics
      - name: "light_bathroom_diagnostics"
        state: "{{ states('light.bathroom_light_light_1') }}"
        attributes:
          icon: "{{ state_attr('light.bathroom_light_light_1', 'icon') }}"
          friendly_name: "Bathroom Light Diagnostics"
          connected: "{{ states('binary_sensor.bathroom_light_status') }}"
          switch_1: "{{ states('binary_sensor.bathroom_light_switch_1') }}"
          switch_2: "{{ states('binary_sensor.bathroom_light_switch_2') }}"
          bssid: "{{ states('sensor.bathroom_light_bssid') }}"
          essid: "{{ state_attr('device_tracker.shelly_bathroom_light_unifi', 'essid') }}"
          esphome_version: "{{ states('sensor.bathroom_light_esphome_version') }}"
          ip: "{{ states('sensor.bathroom_light_ip') }}"
          mac: "{{ states('sensor.bathroom_light_mac') }}"
          ap_mac: "{{ state_attr('device_tracker.shelly_bathroom_light_unifi', 'ap_mac') }}"
          rssi: "{{ states('sensor.bathroom_light_rssi') }}"
          ssid: "{{ states('sensor.bathroom_light_ssid') }}"
          temperature: "{{ states('sensor.bathroom_light_temperature') }}"
          uptime: "{{ states('sensor.bathroom_light_uptime') }}"
          firmware_installed: "{{ state_attr('update.bathroom_light_firmware', 'installed_version') }}"

      - name: "light_bed-a_diagnostics"
        state: "{{ states('light.bed_a_light_light_1') }}"
        attributes:
          icon: "{{ state_attr('light.bed_a_light_light_1', 'icon') }}"
          friendly_name: "Bed A Light Diagnostics"
          connected: "{{ states('binary_sensor.bed_a_light_status') }}"
          switch_1: "{{ states('binary_sensor.bed_a_light_switch_1') }}"
          switch_2: "{{ states('binary_sensor.bed_a_light_switch_2') }}"
          bssid: "{{ states('sensor.bed_a_light_bssid') }}"
          essid: "{{ state_attr('device_tracker.shelly_bed_a_light_unifi', 'essid') }}"
          esphome_version: "{{ states('sensor.bed_a_light_esphome_version') }}"
          ip: "{{ states('sensor.bed_a_light_ip') }}"
          mac: "{{ states('sensor.bed_a_light_mac') }}"
          ap_mac: "{{ state_attr('device_tracker.shelly_bed_a_light_unifi', 'ap_mac') }}"
          rssi: "{{ states('sensor.bed_a_light_rssi') }}"
          ssid: "{{ states('sensor.bed_a_light_ssid') }}"
          temperature: "{{ states('sensor.bed_a_light_temperature') }}"
          uptime: "{{ states('sensor.bed_a_light_uptime') }}"
          firmware_installed: "{{ state_attr('update.bed_a_light_firmware', 'installed_version') }}"

      - name: "light_bed-b_diagnostics"
        state: "{{ states('light.bed_b_light_light_1') }}"
        attributes:
          icon: "{{ state_attr('light.bed_b_light_light_1', 'icon') }}"
          friendly_name: "Bed B Light Diagnostics"
          connected: "{{ states('binary_sensor.bed_b_light_status') }}"
          switch_1: "{{ states('binary_sensor.bed_b_light_switch_1') }}"
          switch_2: "{{ states('binary_sensor.bed_b_light_switch_2') }}"
          bssid: "{{ states('sensor.bed_b_light_bssid') }}"
          essid: "{{ state_attr('device_tracker.shelly_bed_b_light_unifi', 'essid') }}"
          esphome_version: "{{ states('sensor.bed_b_light_esphome_version') }}"
          ip: "{{ states('sensor.bed_b_light_ip') }}"
          mac: "{{ states('sensor.bed_b_light_mac') }}"
          ap_mac: "{{ state_attr('device_tracker.shelly_bed_b_light_unifi', 'ap_mac') }}"
          rssi: "{{ states('sensor.bed_b_light_rssi') }}"
          ssid: "{{ states('sensor.bed_b_light_ssid') }}"
          temperature: "{{ states('sensor.bed_b_light_temperature') }}"
          uptime: "{{ states('sensor.bed_b_light_uptime') }}"
          firmware_installed: "{{ state_attr('update.bed_b_light_firmware', 'installed_version') }}"

      - name: "light_bed-c_diagnostics"
        state: "{{ states('light.bed_c_light_1') }}"
        attributes:
          icon: "{{ state_attr('light.bed_c_light_1', 'icon') }}"
          friendly_name: "Bed C Light Diagnostics"
          connected: "{{ states('binary_sensor.bed_c_light_status') }}"
          switch_1: "{{ states('binary_sensor.bed_c_light_switch_1') }}"
          switch_2: "{{ states('binary_sensor.bed_c_light_switch_2') }}"
          bssid: "{{ states('sensor.bed_c_light_bssid') }}"
          essid: "{{ state_attr('device_tracker.shelly_bed_c_light_unifi', 'essid') }}"
          esphome_version: "{{ states('sensor.bed_c_light_esphome_version') }}"
          ip: "{{ states('sensor.bed_c_light_ip') }}"
          mac: "{{ states('sensor.bed_c_light_mac') }}"
          ap_mac: "{{ state_attr('device_tracker.shelly_bed_c_light_unifi', 'ap_mac') }}"
          rssi: "{{ states('sensor.bed_c_light_rssi') }}"
          ssid: "{{ states('sensor.bed_c_light_ssid') }}"
          temperature: "{{ states('sensor.bed_c_light_temperature') }}"
          uptime: "{{ states('sensor.bed_c_light_uptime') }}"
          firmware_installed: "{{ state_attr('update.bed_c_light_firmware', 'installed_version') }}"

      - name: "light_bed-e_diagnostics"
        state: "{{ states('light.bed_e_light_light_1') }}"
        attributes:
          icon: "{{ state_attr('light.bed_e_light_light_1', 'icon') }}"
          friendly_name: "Bed E Light Diagnostics"
          connected: "{{ states('binary_sensor.bed_e_light_status') }}"
          switch_1: "{{ states('binary_sensor.bed_e_light_switch_1') }}"
          switch_2: "{{ states('binary_sensor.bed_e_light_switch_2') }}"
          bssid: "{{ states('sensor.bed_e_light_bssid') }}"
          essid: "{{ state_attr('device_tracker.shelly_bed_e_light_unifi', 'essid') }}"
          esphome_version: "{{ states('sensor.bed_e_light_esphome_version') }}"
          ip: "{{ states('sensor.bed_e_light_ip') }}"
          mac: "{{ states('sensor.bed_e_light_mac') }}"
          ap_mac: "{{ state_attr('device_tracker.shelly_bed_e_light_unifi', 'ap_mac') }}"
          rssi: "{{ states('sensor.bed_e_light_rssi') }}"
          ssid: "{{ states('sensor.bed_e_light_ssid') }}"
          temperature: "{{ states('sensor.bed_e_light_temperature') }}"
          uptime: "{{ states('sensor.bed_e_light_uptime') }}"
          firmware_installed: "{{ state_attr('update.bed_e_light_firmware', 'installed_version') }}"

      - name: "light_ensuite_diagnostics"
        state: "{{ states('light.ensuite_light_light_1') }}"
        attributes:
          icon: "{{ state_attr('light.ensuite_light_light_1', 'icon') }}"
          friendly_name: "En-suite Light Diagnostics"
          connected: "{{ states('binary_sensor.ensuite_light_status') }}"
          switch_1: "{{ states('binary_sensor.ensuite_light_switch_1') }}"
          switch_2: "{{ states('binary_sensor.ensuite_light_switch_2') }}"
          bssid: "{{ states('sensor.ensuite_light_bssid') }}"
          essid: "{{ state_attr('device_tracker.shelly_ensuite_light_unifi', 'essid') }}"
          esphome_version: "{{ states('sensor.ensuite_light_esphome_version') }}"
          ip: "{{ states('sensor.ensuite_light_ip') }}"
          mac: "{{ states('sensor.ensuite_light_mac') }}"
          ap_mac: "{{ state_attr('device_tracker.shelly_ensuite_light_unifi', 'ap_mac') }}"
          rssi: "{{ states('sensor.ensuite_light_rssi') }}"
          ssid: "{{ states('sensor.ensuite_light_ssid') }}"
          temperature: "{{ states('sensor.ensuite_light_temperature') }}"
          uptime: "{{ states('sensor.ensuite_light_uptime') }}"
          firmware_installed: "{{ state_attr('update.ensuite_light_firmware', 'installed_version') }}"

      - name: "light_hallway-bottom_diagnostics"
        state: "{{ states('light.hallway_bottom_light_1') }}"
        attributes:
          icon: "{{ state_attr('light.hallway_bottom_light_1', 'icon') }}"
          friendly_name: "Bottom Hallway Light Diagnostics"
          connected: "{{ states('binary_sensor.hallway_bottom_light_status') }}"
          switch_1: "{{ states('binary_sensor.hallway_bottom_light_switch_1') }}"
          switch_2: "{{ states('binary_sensor.hallway_bottom_light_switch_2') }}"
          bssid: "{{ states('sensor.hallway_bottom_light_bssid') }}"
          essid: "{{ state_attr('device_tracker.shelly_hallway_bottom_light_unifi', 'essid') }}"
          esphome_version: "{{ states('sensor.hallway_bottom_light_esphome_version') }}"
          ip: "{{ states('sensor.hallway_bottom_light_ip') }}"
          mac: "{{ states('sensor.hallway_bottom_light_mac') }}"
          ap_mac: "{{ state_attr('device_tracker.shelly_hallway_bottom_light_unifi', 'ap_mac') }}"
          rssi: "{{ states('sensor.hallway_bottom_light_rssi') }}"
          ssid: "{{ states('sensor.hallway_bottom_light_ssid') }}"
          temperature: "{{ states('sensor.hallway_bottom_light_temperature') }}"
          uptime: "{{ states('sensor.hallway_bottom_light_uptime') }}"
          firmware_installed: "{{ state_attr('update.hallway_bottom_light_firmware', 'installed_version') }}"

      - name: "light_hallway-middle_diagnostics"
        state: "{{ states('light.middle_hallway_light_light_1') }}"
        attributes:
          icon: "{{ state_attr('light.middle_hallway_light_light_1', 'icon') }}"
          friendly_name: "Middle Hallway Light Diagnostics"
          connected: "{{ states('binary_sensor.hallway_middle_light_status') }}"
          switch_1: "{{ states('binary_sensor.hallway_middle_light_switch_1') }}"
          switch_2: "{{ states('binary_sensor.hallway_middle_light_switch_2') }}"
          bssid: "{{ states('sensor.hallway_middle_light_bssid') }}"
          essid: "{{ state_attr('device_tracker.shelly_hallway_middle_light_unifi', 'essid') }}"
          esphome_version: "{{ states('sensor.hallway_middle_light_esphome_version') }}"
          ip: "{{ states('sensor.hallway_middle_light_ip') }}"
          mac: "{{ states('sensor.hallway_middle_light_mac') }}"
          ap_mac: "{{ state_attr('device_tracker.shelly_hallway_middle_light_unifi', 'ap_mac') }}"
          rssi: "{{ states('sensor.hallway_middle_light_rssi') }}"
          ssid: "{{ states('sensor.hallway_middle_light_ssid') }}"
          temperature: "{{ states('sensor.hallway_middle_light_temperature') }}"
          uptime: "{{ states('sensor.hallway_middle_light_uptime') }}"
          firmware_installed: "{{ state_attr('update.hallway_middle_light_firmware', 'installed_version') }}"

      - name: "light_kitchen-main_diagnostics"
        state: "{{ states('light.kitchen_main_light_light_1') }}"
        attributes:
          icon: "{{ state_attr('light.kitchen_main_light_light_1', 'icon') }}"
          friendly_name: "Kitchen Main Light Diagnostics"
          connected: "{{ states('binary_sensor.kitchen_main_light_status') }}"
          switch_1: "{{ states('binary_sensor.kitchen_main_light_switch_1') }}"
          switch_2: "{{ states('binary_sensor.kitchen_main_light_switch_2') }}"
          bssid: "{{ states('sensor.kitchen_main_light_bssid') }}"
          essid: "{{ state_attr('device_tracker.shelly_kitchen_main_light_unifi', 'essid') }}"
          esphome_version: "{{ states('sensor.kitchen_main_light_esphome_version') }}"
          ip: "{{ states('sensor.kitchen_main_light_ip') }}"
          mac: "{{ states('sensor.kitchen_main_light_mac') }}"
          ap_mac: "{{ state_attr('device_tracker.shelly_kitchen_main_light_unifi', 'ap_mac') }}"
          rssi: "{{ states('sensor.kitchen_main_light_rssi') }}"
          ssid: "{{ states('sensor.kitchen_main_light_ssid') }}"
          temperature: "{{ states('sensor.kitchen_main_light_temperature') }}"
          uptime: "{{ states('sensor.kitchen_main_light_uptime') }}"
          firmware_installed: "{{ state_attr('update.kitchen_main_light_firmware', 'installed_version') }}"

      - name: "light_kitchen-utility_diagnostics"
        state: "{{ states('light.kitchen_utility_light_light_1') }}"
        attributes:
          icon: "{{ state_attr('light.kitchen_utility_light_light_1', 'icon') }}"
          friendly_name: "Kitchen Utility Light Diagnostics"
          connected: "{{ states('binary_sensor.kitchen_utility_light_status') }}"
          switch_1: "{{ states('binary_sensor.kitchen_utility_light_switch_1') }}"
          switch_2: "{{ states('binary_sensor.kitchen_utility_light_switch_2') }}"
          bssid: "{{ states('sensor.kitchen_utility_light_bssid') }}"
          essid: "{{ state_attr('device_tracker.shelly_kitchen_utility_light_unifi', 'essid') }}"
          esphome_version: "{{ states('sensor.kitchen_utility_light_esphome_version') }}"
          ip: "{{ states('sensor.kitchen_utility_light_ip') }}"
          mac: "{{ states('sensor.kitchen_utility_light_mac') }}"
          ap_mac: "{{ state_attr('device_tracker.shelly_kitchen_utility_light_unifi', 'ap_mac') }}"
          rssi: "{{ states('sensor.kitchen_utility_light_rssi') }}"
          ssid: "{{ states('sensor.kitchen_utility_light_ssid') }}"
          temperature: "{{ states('sensor.kitchen_utility_light_temperature') }}"
          uptime: "{{ states('sensor.kitchen_utility_light_uptime') }}"
          firmware_installed: "{{ state_attr('update.kitchen_utility_light_firmware', 'installed_version') }}"

      # - name: "light_kitchen-utility_2_diagnostics"
      #   state: "{{ states('light.kitchen_utility_light_light_2') }}"
      #   attributes:
      #     icon: "{{ state_attr('light.kitchen_utility_light_light_2', 'icon') }}"
      #     friendly_name: "Back Door Light Diagnostics"

      - name: "light_lounge_diagnostics"
        state: "{{ states('light.lounge_light_light_1') }}"
        attributes:
          icon: "{{ state_attr('light.lounge_light_light_1', 'icon') }}"
          friendly_name: "Lounge Light Diagnostics"
          connected: "{{ states('binary_sensor.lounge_light_status') }}"
          switch_1: "{{ states('binary_sensor.lounge_light_switch_1') }}"
          switch_2: "{{ states('binary_sensor.lounge_light_switch_2') }}"
          bssid: "{{ states('sensor.lounge_light_bssid') }}"
          essid: "{{ state_attr('device_tracker.shelly_lounge_light_unifi', 'essid') }}"
          esphome_version: "{{ states('sensor.lounge_light_esphome_version') }}"
          ip: "{{ states('sensor.lounge_light_ip') }}"
          mac: "{{ states('sensor.lounge_light_mac') }}"
          ap_mac: "{{ state_attr('device_tracker.shelly_lounge_light_unifi', 'ap_mac') }}"
          rssi: "{{ states('sensor.lounge_light_rssi') }}"
          ssid: "{{ states('sensor.lounge_light_ssid') }}"
          temperature: "{{ states('sensor.lounge_light_temperature') }}"
          uptime: "{{ states('sensor.lounge_light_uptime') }}"
          firmware_installed: "{{ state_attr('update.lounge_light_firmware', 'installed_version') }}"

      - name: "light_study_diagnostics"
        state: "{{ states('light.study_light_light_1') }}"
        attributes:
          icon: "{{ state_attr('light.study_light_light_1', 'icon') }}"
          friendly_name: "Study Light Diagnostics"
          connected: "{{ states('binary_sensor.study_light_status') }}"
          switch_1: "{{ states('binary_sensor.study_light_switch_1') }}"
          switch_2: "{{ states('binary_sensor.study_light_switch_2') }}"
          bssid: "{{ states('sensor.study_light_bssid') }}"
          essid: "{{ state_attr('device_tracker.shelly_study_light_unifi', 'essid') }}"
          esphome_version: "{{ states('sensor.study_light_esphome_version') }}"
          ip: "{{ states('sensor.study_light_ip') }}"
          mac: "{{ states('sensor.study_light_mac') }}"
          ap_mac: "{{ state_attr('device_tracker.shelly_study_light_unifi', 'ap_mac') }}"
          rssi: "{{ states('sensor.study_light_rssi') }}"
          ssid: "{{ states('sensor.study_light_ssid') }}"
          temperature: "{{ states('sensor.study_light_temperature') }}"
          uptime: "{{ states('sensor.study_light_uptime') }}"
          firmware_installed: "{{ state_attr('update.study_light_firmware', 'installed_version') }}"

  - binary_sensor:
      - name: "kev_driving_status"
        state: "{{ 'on' if states('sensor.iphone_activity') == 'Automotive' else 'off' }}"
